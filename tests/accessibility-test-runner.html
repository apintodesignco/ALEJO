<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALEJO Accessibility Test Runner</title>
  <style>
    :root {
      --primary-color: #4299e1;
      --secondary-color: #2b6cb0;
      --text-color: #2d3748;
      --background-color: #f7fafc;
      --card-background: #ffffff;
      --border-color: #e2e8f0;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #e53e3e;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--background-color);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: var(--text-color);
    }

    .test-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--secondary-color);
    }

    button.secondary {
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    button.secondary:hover {
      background-color: rgba(66, 153, 225, 0.1);
    }

    button.success {
      background-color: var(--success-color);
    }

    button.warning {
      background-color: var(--warning-color);
    }

    button.danger {
      background-color: var(--danger-color);
    }

    .test-section {
      background-color: var(--card-background);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }

    .test-results {
      background-color: #2d3748;
      color: #ffffff;
      padding: 1rem;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
    }

    .test-result-entry {
      margin: 0;
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .test-result-entry.success {
      color: var(--success-color);
    }

    .test-result-entry.error {
      color: var(--danger-color);
    }

    .test-result-entry.info {
      color: #63b3ed;
    }

    .test-result-entry.warning {
      color: var(--warning-color);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .feature-card {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 1rem;
    }

    .feature-card h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .status-success {
      background-color: var(--success-color);
    }

    .status-error {
      background-color: var(--danger-color);
    }

    .status-warning {
      background-color: var(--warning-color);
    }

    .status-pending {
      background-color: #cbd5e0;
    }

    .test-frame-container {
      border: 1px solid var(--border-color);
      margin-top: 1rem;
      border-radius: 4px;
    }

    .test-frame {
      width: 100%;
      height: 600px;
      border: none;
    }

    .tabs {
      display: flex;
      margin-top: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: 1px solid transparent;
      margin-right: 0.5rem;
    }

    .tab.active {
      border: 1px solid var(--border-color);
      border-bottom: none;
      background-color: var(--card-background);
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      position: relative;
      bottom: -1px;
    }

    .tab-content {
      padding: 1rem;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .resource-monitor {
      background-color: var(--card-background);
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .resource-bar {
      height: 10px;
      background-color: var(--border-color);
      border-radius: 5px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .resource-bar-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.5s ease;
    }

    .resource-bar-fill.warning {
      background-color: var(--warning-color);
    }

    .resource-bar-fill.danger {
      background-color: var(--danger-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ALEJO Accessibility Test Runner</h1>
      <div class="test-controls">
        <button id="run-all-tests">Run All Tests</button>
        <button id="stop-tests" class="danger">Stop Tests</button>
        <button id="toggle-test-page" class="secondary">Toggle Test Page</button>
      </div>
    </header>

    <div class="resource-monitor">
      <h3>System Resource Monitor</h3>
      <div>
        <label>CPU Usage:</label>
        <div class="resource-bar">
          <div id="cpu-bar" class="resource-bar-fill"></div>
        </div>
        <span id="cpu-usage">0%</span>
      </div>
      <div>
        <label>Memory Usage:</label>
        <div class="resource-bar">
          <div id="memory-bar" class="resource-bar-fill"></div>
        </div>
        <span id="memory-usage">0%</span>
      </div>
    </div>

    <div class="test-section">
      <h2>Feature Status</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <span id="aria-status" class="status-indicator status-pending"></span>
          <h3>ARIA Manager</h3>
          <p id="aria-message">Not tested</p>
          <button class="test-feature-btn" data-feature="aria">Test Feature</button>
        </div>
        <div class="feature-card">
          <span id="keyboard-status" class="status-indicator status-pending"></span>
          <h3>Keyboard Navigation</h3>
          <p id="keyboard-message">Not tested</p>
          <button class="test-feature-btn" data-feature="keyboard">Test Feature</button>
        </div>
        <div class="feature-card">
          <span id="visual-status" class="status-indicator status-pending"></span>
          <h3>Visual Adaptations</h3>
          <p id="visual-message">Not tested</p>
          <button class="test-feature-btn" data-feature="visual">Test Feature</button>
        </div>
        <div class="feature-card">
          <span id="panel-status" class="status-indicator status-pending"></span>
          <h3>Accessibility Panel</h3>
          <p id="panel-message">Not tested</p>
          <button class="test-feature-btn" data-feature="panel">Test Feature</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="log-tab">Test Log</div>
      <div class="tab" data-tab="test-page-tab">Test Page</div>
      <div class="tab" data-tab="integration-tab">Integration Tests</div>
    </div>

    <div id="log-tab" class="tab-content active">
      <div class="test-results" id="test-log">
        <p class="test-result-entry info">Test runner initialized. Click "Run All Tests" to begin.</p>
      </div>
    </div>

    <div id="test-page-tab" class="tab-content">
      <div class="test-frame-container">
        <iframe id="test-frame" class="test-frame" src="accessibility-features-test.html" title="Accessibility Test Page"></iframe>
      </div>
    </div>

    <div id="integration-tab" class="tab-content">
      <div class="test-controls">
        <button id="run-integration-tests">Run Integration Tests</button>
        <button id="clear-integration-log" class="secondary">Clear Log</button>
      </div>
      <div class="test-results" id="integration-log">
        <p class="test-result-entry info">Integration tests ready. Click "Run Integration Tests" to begin.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { runTests as runIntegrationTests } from './accessibility-integration-test.js';
    import { 
      AriaManager, 
      AriaEnhancer, 
      KeyboardNavigationManager, 
      VisualAdaptationsManager, 
      AccessibilityPanel 
    } from '../src/personalization/accessibility/index.js';

    // State tracking
    const testState = {
      running: false,
      features: {
        aria: { tested: false, passed: false },
        keyboard: { tested: false, passed: false },
        visual: { tested: false, passed: false },
        panel: { tested: false, passed: false }
      },
      resourceMonitor: null
    };

    // DOM elements
    const elements = {
      testLog: document.getElementById('test-log'),
      integrationLog: document.getElementById('integration-log'),
      testFrame: document.getElementById('test-frame'),
      runAllButton: document.getElementById('run-all-tests'),
      stopButton: document.getElementById('stop-tests'),
      togglePageButton: document.getElementById('toggle-test-page'),
      runIntegrationButton: document.getElementById('run-integration-tests'),
      clearIntegrationLogButton: document.getElementById('clear-integration-log'),
      featureButtons: document.querySelectorAll('.test-feature-btn'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      cpuBar: document.getElementById('cpu-bar'),
      cpuUsage: document.getElementById('cpu-usage'),
      memoryBar: document.getElementById('memory-bar'),
      memoryUsage: document.getElementById('memory-usage')
    };

    // Initialize
    function initialize() {
      setupEventListeners();
      log('Test runner initialized successfully.', 'info');
      monitorResources();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Main control buttons
      elements.runAllButton.addEventListener('click', runAllTests);
      elements.stopButton.addEventListener('click', stopTests);
      elements.togglePageButton.addEventListener('click', toggleTestPage);
      
      // Individual feature test buttons
      elements.featureButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          testFeature(btn.dataset.feature);
        });
      });

      // Tab navigation
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          activateTab(tabId);
        });
      });

      // Integration test controls
      elements.runIntegrationButton.addEventListener('click', () => {
        log('Running integration tests...', 'info', elements.integrationLog);
        
        // Create a special console logger to capture integration test logs
        const originalConsoleLog = console.log;
        console.log = function(message, style) {
          originalConsoleLog.apply(console, arguments);
          if (typeof message === 'string') {
            let type = 'info';
            if (style && style.includes('green')) type = 'success';
            if (style && style.includes('red')) type = 'error';
            if (style && style.includes('orange')) type = 'warning';
            log(message, type, elements.integrationLog);
          }
        };
        
        // Run integration tests
        try {
          runIntegrationTests();
        } catch (error) {
          log(`Error in integration tests: ${error.message}`, 'error', elements.integrationLog);
        }
        
        // Restore console.log
        setTimeout(() => {
          console.log = originalConsoleLog;
        }, 1000);
      });

      elements.clearIntegrationLogButton.addEventListener('click', () => {
        elements.integrationLog.innerHTML = '';
        log('Integration test log cleared.', 'info', elements.integrationLog);
      });
    }

    // Run all tests
    async function runAllTests() {
      if (testState.running) {
        log('Tests are already running.', 'warning');
        return;
      }

      testState.running = true;
      elements.runAllButton.disabled = true;
      log('Starting all accessibility feature tests...', 'info');

      try {
        await testAriaManager();
        await testKeyboardNavigation();
        await testVisualAdaptations();
        await testAccessibilityPanel();
        
        log('All tests completed.', 'success');
        testState.running = false;
        elements.runAllButton.disabled = false;
      } catch (error) {
        log(`Test sequence error: ${error.message}`, 'error');
        testState.running = false;
        elements.runAllButton.disabled = false;
      }
    }

    // Stop tests
    function stopTests() {
      if (!testState.running) {
        log('No tests are currently running.', 'info');
        return;
      }

      testState.running = false;
      elements.runAllButton.disabled = false;
      log('Tests stopped by user.', 'warning');
    }

    // Toggle test page visibility
    function toggleTestPage() {
      const testPageTab = document.querySelector('[data-tab="test-page-tab"]');
      if (testPageTab.classList.contains('active')) {
        activateTab('log-tab');
      } else {
        activateTab('test-page-tab');
      }
    }

    // Activate a tab
    function activateTab(tabId) {
      elements.tabs.forEach(tab => {
        if (tab.dataset.tab === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      elements.tabContents.forEach(content => {
        if (content.id === tabId) {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });
    }

    // Test specific feature
    async function testFeature(feature) {
      if (testState.running) {
        log(`Cannot test ${feature} while other tests are running.`, 'warning');
        return;
      }

      testState.running = true;
      log(`Testing ${feature} feature...`, 'info');

      try {
        switch (feature) {
          case 'aria':
            await testAriaManager();
            break;
          case 'keyboard':
            await testKeyboardNavigation();
            break;
          case 'visual':
            await testVisualAdaptations();
            break;
          case 'panel':
            await testAccessibilityPanel();
            break;
        }
        
        testState.running = false;
      } catch (error) {
        log(`Error testing ${feature}: ${error.message}`, 'error');
        testState.running = false;
      }
    }

    // Test ARIA Manager
    async function testAriaManager() {
      log('Testing ARIA Manager...', 'info');
      updateFeatureStatus('aria', 'testing', 'Testing in progress');

      try {
        // Check if ARIA Manager is defined
        if (!AriaManager) {
          throw new Error('ARIA Manager not found');
        }
        
        // Initialize ARIA Manager if not already initialized
        if (!AriaManager.isInitialized) {
          await AriaManager.initialize();
        }
        
        // Test announcement functionality
        const testMessage = 'ARIA Manager test message';
        AriaManager.announceMessage(testMessage);
        
        // Add delay to let announcement happen
        await delay(300);
        
        // Check the announcer element
        const announcer = document.getElementById('alejo-screen-reader-announcer');
        if (!announcer) {
          throw new Error('ARIA announcer element not found');
        }
        
        log('ARIA Manager initialized successfully', 'success');
        updateFeatureStatus('aria', 'success', 'Initialized and announcements working');
        
        return true;
      } catch (error) {
        log(`ARIA Manager test failed: ${error.message}`, 'error');
        updateFeatureStatus('aria', 'error', `Failed: ${error.message}`);
        throw error;
      }
    }

    // Test Keyboard Navigation Manager
    async function testKeyboardNavigation() {
      log('Testing Keyboard Navigation Manager...', 'info');
      updateFeatureStatus('keyboard', 'testing', 'Testing in progress');

      try {
        // Check if Keyboard Navigation Manager is defined
        if (!KeyboardNavigationManager) {
          throw new Error('Keyboard Navigation Manager not found');
        }
        
        // Initialize Keyboard Navigation Manager if not already initialized
        if (!KeyboardNavigationManager.isInitialized) {
          await KeyboardNavigationManager.initialize();
        }
        
        // Test focus trap creation
        const testContainer = document.createElement('div');
        testContainer.innerHTML = `
          <div>
            <button>Test Button 1</button>
            <button>Test Button 2</button>
          </div>
        `;
        document.body.appendChild(testContainer);
        
        const trapId = KeyboardNavigationManager.createFocusTrap(testContainer);
        
        if (!trapId) {
          throw new Error('Failed to create focus trap');
        }
        
        // Test focus trap removal
        KeyboardNavigationManager.removeFocusTrap(trapId);
        
        // Cleanup
        document.body.removeChild(testContainer);
        
        log('Keyboard Navigation Manager initialized successfully', 'success');
        updateFeatureStatus('keyboard', 'success', 'Initialized and focus traps working');
        
        return true;
      } catch (error) {
        log(`Keyboard Navigation Manager test failed: ${error.message}`, 'error');
        updateFeatureStatus('keyboard', 'error', `Failed: ${error.message}`);
        throw error;
      }
    }

    // Test Visual Adaptations Manager
    async function testVisualAdaptations() {
      log('Testing Visual Adaptations Manager...', 'info');
      updateFeatureStatus('visual', 'testing', 'Testing in progress');

      try {
        // Check if Visual Adaptations Manager is defined
        if (!VisualAdaptationsManager) {
          throw new Error('Visual Adaptations Manager not found');
        }
        
        // Initialize Visual Adaptations Manager if not already initialized
        if (!VisualAdaptationsManager.isInitialized) {
          await VisualAdaptationsManager.initialize();
        }
        
        // Test high contrast mode
        await VisualAdaptationsManager.updateSetting('highContrast', true);
        await delay(300);
        
        // Check if high contrast class is applied
        const hasHighContrast = document.documentElement.classList.contains('alejo-high-contrast');
        
        // Test font size adjustment
        const originalFontSize = VisualAdaptationsManager.getSettings().fontSize || 100;
        await VisualAdaptationsManager.updateSetting('fontSize', 120);
        await delay(300);
        
        // Check if font scaling class is applied
        const hasFontScaling = document.documentElement.classList.contains('alejo-font-scaled');
        
        // Reset settings
        await VisualAdaptationsManager.updateSetting('highContrast', false);
        await VisualAdaptationsManager.updateSetting('fontSize', originalFontSize);
        
        log('Visual Adaptations Manager initialized successfully', 'success');
        updateFeatureStatus('visual', 'success', 'Initialized and adaptations working');
        
        return true;
      } catch (error) {
        log(`Visual Adaptations Manager test failed: ${error.message}`, 'error');
        updateFeatureStatus('visual', 'error', `Failed: ${error.message}`);
        throw error;
      }
    }

    // Test Accessibility Panel
    async function testAccessibilityPanel() {
      log('Testing Accessibility Panel...', 'info');
      updateFeatureStatus('panel', 'testing', 'Testing in progress');

      try {
        // Check if Accessibility Panel is defined
        if (!AccessibilityPanel) {
          throw new Error('Accessibility Panel not found');
        }
        
        // Initialize Accessibility Panel if not already initialized
        if (!AccessibilityPanel.isInitialized) {
          await AccessibilityPanel.initialize();
        }
        
        // Show the panel
        AccessibilityPanel.show();
        await delay(500);
        
        // Check if panel is visible in DOM
        const panelElement = document.getElementById('alejo-accessibility-panel');
        if (!panelElement) {
          throw new Error('Accessibility Panel element not found in DOM');
        }
        
        // Test panel visibility
        const isVisible = panelElement.style.display !== 'none';
        if (!isVisible) {
          throw new Error('Accessibility Panel was not shown properly');
        }
        
        // Hide the panel
        AccessibilityPanel.hide();
        await delay(300);
        
        log('Accessibility Panel initialized successfully', 'success');
        updateFeatureStatus('panel', 'success', 'Initialized and panel working');
        
        return true;
      } catch (error) {
        log(`Accessibility Panel test failed: ${error.message}`, 'error');
        updateFeatureStatus('panel', 'error', `Failed: ${error.message}`);
        throw error;
      }
    }

    // Update feature status display
    function updateFeatureStatus(feature, status, message) {
      const statusIndicator = document.getElementById(`${feature}-status`);
      const messageElement = document.getElementById(`${feature}-message`);
      
      if (statusIndicator && messageElement) {
        // Update status indicator
        statusIndicator.className = 'status-indicator';
        switch (status) {
          case 'success':
            statusIndicator.classList.add('status-success');
            testState.features[feature].tested = true;
            testState.features[feature].passed = true;
            break;
          case 'error':
            statusIndicator.classList.add('status-error');
            testState.features[feature].tested = true;
            testState.features[feature].passed = false;
            break;
          case 'warning':
            statusIndicator.classList.add('status-warning');
            break;
          case 'testing':
            statusIndicator.classList.add('status-pending');
            break;
          default:
            statusIndicator.classList.add('status-pending');
        }
        
        // Update message
        messageElement.textContent = message;
      }
    }

    // Log messages to the test log
    function log(message, type = 'info', target = elements.testLog) {
      const entry = document.createElement('p');
      entry.classList.add('test-result-entry');
      entry.classList.add(type);
      
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      
      target.appendChild(entry);
      target.scrollTop = target.scrollHeight;
    }

    // Helper function to create a delay
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Monitor system resources (simulated)
    function monitorResources() {
      // Reset resource monitor
      if (testState.resourceMonitor) {
        clearInterval(testState.resourceMonitor);
      }
      
      // Start monitoring (simulated)
      testState.resourceMonitor = setInterval(() => {
        // Get a simulated CPU usage between 5-15%
        // In a real implementation, this would use actual performance metrics
        const cpuUsage = 5 + Math.floor(Math.random() * 10);
        
        // Get a simulated memory usage between 20-40%
        const memoryUsage = 20 + Math.floor(Math.random() * 20);
        
        // Update the UI
        updateResourceDisplay(cpuUsage, memoryUsage);
      }, 2000);
    }

    // Update resource display
    function updateResourceDisplay(cpu, memory) {
      // Update CPU display
      elements.cpuBar.style.width = `${cpu}%`;
      elements.cpuUsage.textContent = `${cpu}%`;
      
      if (cpu > 80) {
        elements.cpuBar.className = 'resource-bar-fill danger';
      } else if (cpu > 60) {
        elements.cpuBar.className = 'resource-bar-fill warning';
      } else {
        elements.cpuBar.className = 'resource-bar-fill';
      }
      
      // Update memory display
      elements.memoryBar.style.width = `${memory}%`;
      elements.memoryUsage.textContent = `${memory}%`;
      
      if (memory > 80) {
        elements.memoryBar.className = 'resource-bar-fill danger';
      } else if (memory > 60) {
        elements.memoryBar.className = 'resource-bar-fill warning';
      } else {
        elements.memoryBar.className = 'resource-bar-fill';
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
